<!--
  Copyright (C) 2024 Nethesis S.r.l.
  SPDX-License-Identifier: GPL-3.0-or-later
-->

<script setup lang="ts">
import { CYAN_500, CYAN_600, INDIGO_400, INDIGO_600 } from '@/lib/color'
import { ubusCall } from '@/lib/standalone/ubus'
import { useThemeStore } from '@/stores/theme'
import { NeCard, NeSkeleton, getAxiosErrorMessage } from '@nethesis/vue-components'
import { onMounted, onUnmounted, ref } from 'vue'
import { useI18n } from 'vue-i18n'
import InterfaceTrafficChart from '../traffic/InterfaceTrafficChart.vue'

const props = defineProps<{
  iface?: string
  device: string
}>()

const { t } = useI18n()
const themeStore = useThemeStore()

// random refresh interval between 20 and 30 seconds
const REFRESH_INTERVAL = 20000 + Math.random() * 10 * 1000
const chartLabels = ref<any[]>([])
const chartDatasets = ref<any[]>([])
const intervalId = ref(0)

const mockInterfaceTrafficData = {
  result: {
    labels: [
      1727166040, 1727166020, 1727166000, 1727165980, 1727165960, 1727165940, 1727165920,
      1727165900, 1727165880, 1727165860, 1727165840, 1727165820, 1727165800, 1727165780,
      1727165760, 1727165740, 1727165720, 1727165700, 1727165680, 1727165660, 1727165640,
      1727165620, 1727165600, 1727165580, 1727165560, 1727165540, 1727165520, 1727165500,
      1727165480, 1727165460, 1727165440, 1727165420, 1727165400, 1727165380, 1727165360,
      1727165340, 1727165320, 1727165300, 1727165280, 1727165260, 1727165240, 1727165220,
      1727165200, 1727165180, 1727165160, 1727165140, 1727165120, 1727165100, 1727165080,
      1727165060, 1727165040, 1727165020, 1727165000, 1727164980, 1727164960, 1727164940,
      1727164920, 1727164900, 1727164880, 1727164860, 1727164840, 1727164820, 1727164800,
      1727164780, 1727164760, 1727164740, 1727164720, 1727164700, 1727164680, 1727164660,
      1727164640, 1727164620, 1727164600, 1727164580, 1727164560, 1727164540, 1727164520,
      1727164500, 1727164480, 1727164460, 1727164440, 1727164420, 1727164400, 1727164380,
      1727164360, 1727164340, 1727164320, 1727164300, 1727164280, 1727164260, 1727164240,
      1727164220, 1727164200, 1727164180, 1727164160, 1727164140, 1727164120, 1727164100,
      1727164080, 1727164060, 1727164040, 1727164020, 1727164000, 1727163980, 1727163960,
      1727163940, 1727163920, 1727163900, 1727163880, 1727163860, 1727163840, 1727163820,
      1727163800, 1727163780, 1727163760, 1727163740, 1727163720, 1727163700, 1727163680,
      1727163660, 1727163640, 1727163620, 1727163600, 1727163580, 1727163560, 1727163540,
      1727163520, 1727163500, 1727163480, 1727163460, 1727163440, 1727163420, 1727163400,
      1727163380, 1727163360, 1727163340, 1727163320, 1727163300, 1727163280, 1727163260,
      1727163240, 1727163220, 1727163200, 1727163180, 1727163160, 1727163140, 1727163120,
      1727163100, 1727163080, 1727163060, 1727163040, 1727163020, 1727163000, 1727162980,
      1727162960, 1727162940, 1727162920, 1727162900, 1727162880, 1727162860, 1727162840,
      1727162820, 1727162800, 1727162780, 1727162760, 1727162740, 1727162720, 1727162700,
      1727162680, 1727162660, 1727162640, 1727162620, 1727162600, 1727162580, 1727162560,
      1727162540, 1727162520, 1727162500, 1727162480, 1727162460
    ],
    data: [
      [0.084, 0.0643242],
      [0.084, 0.0562304],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1069102, 0.0504],
      [0.0840008, 0.0504],
      [0.089089, 0.0642994],
      [0.084, 0.0504124],
      [0.1300568, 0.0532882],
      [0.0939432, 0.0642165],
      [0.084, 0.0640763],
      [0.084, 0.0565072],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1069357, 0.0504],
      [0.084003, 0.0504],
      [0.0890613, 0.0642162],
      [0.084, 0.0504148],
      [0.1298777, 0.0533691],
      [0.0941223, 0.0641496],
      [0.084, 0.0671969],
      [0.084, 0.0534535],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1069357, 0.0504],
      [0.0840062, 0.0504],
      [0.0890581, 0.0642312],
      [0.084, 0.0533688],
      [0.1301533, 0.0504],
      [0.0938467, 0.0641576],
      [0.084, 0.0671883],
      [0.084, 0.0534541],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1070501, 0.0504],
      [0.08398, 0.0504],
      [0.0889699, 0.0641461],
      [0.084, 0.0534539],
      [0.1300499, 0.0504],
      [0.0939501, 0.0642154],
      [0.084, 0.0671307],
      [0.084, 0.0534539],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1070252, 0.0504],
      [0.0839321, 0.0504],
      [0.0890427, 0.0642892],
      [0.084, 0.0533108],
      [0.1298198, 0.0504],
      [0.0941802, 0.0641473],
      [0.084, 0.0673375],
      [0.084, 0.0533152],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1069098, 0.0504],
      [0.08414, 0.0504],
      [0.0889503, 0.0642455],
      [0.084, 0.0533545],
      [0.1299264, 0.0504],
      [0.0940736, 0.0641459],
      [0.084, 0.0672002],
      [0.084, 0.053454],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1070251, 0.0504],
      [0.0839115, 0.0504],
      [0.0890634, 0.064146],
      [0.084, 0.053454],
      [0.1298203, 0.0504],
      [0.0941797, 0.064285],
      [0.084, 0.0672711],
      [0.084, 0.0532439],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1069102, 0.0504],
      [0.0841159, 0.0504],
      [0.0889738, 0.0642307],
      [0.084, 0.0533693],
      [0.1303326, 0.0504],
      [0.0936674, 0.0641613],
      [0.084, 0.0671862],
      [0.084, 0.0534525],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1070266, 0.0504],
      [0.0839089, 0.0504],
      [0.0890645, 0.064164],
      [0.084, 0.053436],
      [0.1298809, 0.0504],
      [0.0941191, 0.0641471],
      [0.084, 0.0673391],
      [0.084, 0.0533138],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1070747, 0.0504],
      [0.0609253, 0.0504],
      [0.112, 0.064159],
      [0.084, 0.053441],
      [0.1299469, 0.0504],
      [0.0940531, 0.0641624],
      [0.084, 0.0671989],
      [0.084, 0.0534387],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1070266, 0.0504],
      [0.0838839, 0.0504],
      [0.0890895, 0.0642312],
      [0.084, 0.0533688],
      [0.1301001, 0.0504],
      [0.0938999, 0.064177],
      [0.084, 0.0672145],
      [0.084, 0.0534085],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1069102, 0.0504],
      [0.0840004, 0.0504],
      [0.0890894, 0.0641612],
      [0.084, 0.0534388],
      [0.1300516, 0.0504],
      [0.0939484, 0.064163],
      [0.084, 0.0671842],
      [0.084, 0.0534528],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1071415, 0.0504],
      [0.0838326, 0.0504],
      [0.0890259, 0.0641462],
      [0.084, 0.0534538],
      [0.1299231, 0.0504],
      [0.0940769, 0.0642317],
      [0.084, 0.0671452],
      [0.084, 0.0534231],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1071464, 0.0504],
      [0.0888536, 0.0642225],
      [0.084, 0.0533775],
      [0.130383, 0.0504],
      [0.093617, 0.0641641],
      [0.084, 0.0672818],
      [0.084, 0.0533542],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.107025, 0.0504],
      [0.0839253, 0.0504],
      [0.0890496, 0.0642308],
      [0.084, 0.0533692],
      [0.1301005, 0.0504],
      [0.0938995, 0.0641467],
      [0.084, 0.0671991],
      [0.084, 0.0534541],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.084, 0.0504],
      [0.1071437, 0.0504],
      [0.0837663, 0.0504],
      [0.0890901, 0.0641477],
      [0.084, 0.0534523],
      [0.1303867, 0.0504],
      [0.0936133, 0.0641663],
      [0.084, 0.0672542],
      [0.084, 0.0533794],
      [0.084, 0.0504],
      [0.084, 0.0504]
    ]
  }
}

let loading = ref({
  getInterfaceTraffic: false
})

let error = ref({
  getInterfaceTraffic: '',
  getInterfaceTrafficDescription: ''
})

onMounted(() => {
  // periodically reload data
  intervalId.value = setInterval(getInterfaceTraffic, REFRESH_INTERVAL)

  getInterfaceTraffic()
})

onUnmounted(() => {
  if (intervalId.value) {
    clearInterval(intervalId.value)
  }
})

async function getInterfaceTraffic() {
  // show skeleton only the first time
  if (!intervalId.value) {
    loading.value.getInterfaceTraffic = true
  }
  error.value.getInterfaceTraffic = ''
  error.value.getInterfaceTrafficDescription = ''

  try {
    const res = await ubusCall('ns.dashboard', 'interface-traffic', {
      interface: props.device
    })
    chartLabels.value = res.data.result.labels.map((timestamp: any) => timestamp * 1000)
    const downloadData = res.data.result.data.map((values: any) => values[0])
    const uploadData = res.data.result.data.map((values: any) => values[1])

    chartDatasets.value = [
      {
        label: t('common.download'),
        borderColor: themeStore.isLight ? CYAN_600 : CYAN_500,
        backgroundColor: themeStore.isLight ? CYAN_600 : CYAN_500,
        data: downloadData,
        borderWidth: 1,
        radius: 0
      },
      {
        label: t('common.upload'),
        borderColor: themeStore.isLight ? INDIGO_600 : INDIGO_400,
        backgroundColor: themeStore.isLight ? INDIGO_600 : INDIGO_400,
        data: uploadData,
        borderWidth: 1,
        radius: 0
      }
    ]
  } catch (err: any) {
    console.error(err)
    error.value.getInterfaceTraffic = t('error.cannot_retrieve_wan_traffic')
    error.value.getInterfaceTrafficDescription = t(getAxiosErrorMessage(err))
  } finally {
    loading.value.getInterfaceTraffic = false
  }
}
</script>

<template>
  <NeCard
    :title="
      t('standalone.real_time_monitor.interface_name_traffic', {
        name: props.iface || props.device
      })
    "
    :skeletonLines="8"
    :loading="loading.getInterfaceTraffic"
    :errorTitle="error.getInterfaceTraffic"
    :errorDescription="error.getInterfaceTrafficDescription"
  >
    <NeSkeleton v-if="loading.getInterfaceTraffic" :lines="6"></NeSkeleton>
    <InterfaceTrafficChart v-else :labels="chartLabels" :datasets="chartDatasets" height="30vh" />
  </NeCard>
</template>
